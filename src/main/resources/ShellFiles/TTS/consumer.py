import pika
import json
from config_loader import config

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó RabbitMQ
rabbitmq_host = config["rabbitmq"]["host"]
rabbitmq_port = config["rabbitmq"]["port"]
rabbitmq_user = config["rabbitmq"]["username"]
rabbitmq_password = config["rabbitmq"]["password"]
input_queue = config["rabbitmq"]["input_queue"]
rabbitmq_vhost = config["rabbitmq"]["vhost"]
output_queue = config["rabbitmq"]["output_queue"]

# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
credentials = pika.PlainCredentials(rabbitmq_user, rabbitmq_password)

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è
connection = pika.BlockingConnection(
        pika.ConnectionParameters(
            host=rabbitmq_host,
            port=rabbitmq_port,
            virtual_host=rabbitmq_vhost,  # –í—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π —Ö–æ—Å—Ç
            credentials=credentials
        )
)
channel = connection.channel()

# –î–µ–∫–ª–∞—Ä–∞—Ü—ñ—è —á–µ—Ä–≥
channel.queue_declare(queue=input_queue)
channel.queue_declare(queue=output_queue)

# –§—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
def process_message(news_rpc_obj):
    """ –§—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ–≥–æ JSON """
    news_rpc_obj["text"] = news_rpc_obj["text"].upper()  # –†–æ–±–∏–º–æ —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–Ω–∏–º–∏ –ª—ñ—Ç–µ—Ä–∞–º–∏
    news_rpc_obj["rc"] = 201  # –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    return news_rpc_obj

# –§—É–Ω–∫—Ü—ñ—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
def callback(ch, method, properties, body):
    print(f"üì• –û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: {body.decode()}")

    # –†–æ–∑–±–∏—Ä–∞—î–º–æ JSON —É Python-—Å–ª–æ–≤–Ω–∏–∫
    news_rpc_obj = json.loads(body.decode())

    # –û–±—Ä–æ–±–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    processed_message = process_message(news_rpc_obj)

    # –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –Ω–∞–∑–∞–¥ —É JSON
    output_json = json.dumps(processed_message)

    # –ù–∞–¥—Å–∏–ª–∞—î–º–æ —É –≤–∏—Ö—ñ–¥–Ω—É —á–µ—Ä–≥—É
    ch.basic_publish(exchange="", routing_key=output_queue, body=output_json)
    print(f"üì§ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —É {output_queue}: {output_json}")

    ch.basic_ack(delivery_tag=method.delivery_tag)  # –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è

# –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Ö—ñ–¥–Ω—É —á–µ—Ä–≥—É
channel.basic_consume(queue=input_queue, on_message_callback=callback)

print("üîÑ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å... –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å CTRL+C –¥–ª—è –≤–∏—Ö–æ–¥—É.")
channel.start_consuming()

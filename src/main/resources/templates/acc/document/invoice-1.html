<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–î–∏–Ω–∞–º—ñ—á–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫-—Ñ–∞–∫—Ç—É—Ä–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .table td, .table th {
            vertical-align: middle;
            text-align: center;
        }
    </style>
</head>
<body class="p-4">

<div class="container">
    <h2 class="mb-4">–†–∞—Ö—É–Ω–æ–∫-—Ñ–∞–∫—Ç—É—Ä–∞</h2>

    <form method="post" th:action="@{/invoice/save}">
        <table class="table table-bordered" id="invoiceTable">
            <thead class="table-light">
            <tr>
                <th>#</th>
                <th>–¢–æ–≤–∞—Ä</th>
                <th>–û–¥. –≤–∏–º—ñ—Ä—É</th>
                <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                <th>–¶—ñ–Ω–∞</th>
                <th>–°—É–º–∞</th>
                <th></th>
            </tr>
            </thead>
            <tbody id="invoiceBody">
            <!-- –†—è–¥–∫–∏ –¥–æ–¥–∞–≤–∞—Ç–∏–º—É—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
            </tbody>
            <tfoot>
            <tr>
                <th colspan="5" class="text-end">–†–∞–∑–æ–º:</th>
                <th id="totalSum">0.00</th>
                <th></th>
            </tr>
            </tfoot>
        </table>

        <button type="button" class="btn btn-secondary" onclick="addRow()">‚ûï –î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</button>
        <button type="submit" class="btn btn-success">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫</button>
    </form>
</div>

<script>
    const products = /*[[${goodsList}]]*/ []; // –º–∞—î –±—É—Ç–∏ List<AccGoodsReference> ‚Äî name, price, measurement.name
    let rowIndex = 0;

    function addRow() {
        const tbody = document.getElementById('invoiceBody');
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${rowIndex + 1}</td>
            <td>
                <select class="form-select form-select-sm" name="items[${rowIndex}].productId" onchange="onProductChange(this, ${rowIndex})">
                    <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä</option>
                    ${products.map(p => `
                        <option value="${p.id}" data-price="${p.price}" data-measurement="${p.measurement.name}">${p.name}</option>
                    `).join('')}
                </select>
            </td>
            <td><input type="text" class="form-control form-control-sm" name="items[${rowIndex}].measurement" readonly /></td>
            <td><input type="number" step="0.001" class="form-control form-control-sm" name="items[${rowIndex}].quantity" oninput="recalculateRow(this)" /></td>
            <td><input type="number" step="0.01" class="form-control form-control-sm" name="items[${rowIndex}].price" oninput="recalculateRow(this)" /></td>
            <td><input type="text" class="form-control form-control-sm" name="items[${rowIndex}].amount" readonly /></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">üóë</button></td>
        `;
        tbody.appendChild(row);
        rowIndex++;
    }

    function onProductChange(select, index) {
        const selected = select.options[select.selectedIndex];
        const row = select.closest('tr');
        const measurementInput = row.querySelector(`input[name="items[${index}].measurement"]`);
        const priceInput = row.querySelector(`input[name="items[${index}].price"]`);
        const quantityInput = row.querySelector(`input[name="items[${index}].quantity"]`);

        measurementInput.value = selected.getAttribute('data-measurement') || '';
        priceInput.value = selected.getAttribute('data-price') || '';
        quantityInput.value = quantityInput.value || 1;

        recalculateRow(quantityInput);
    }

    function recalculateRow(input) {
        const row = input.closest('tr');
        const qty = parseFloat(row.querySelector('[name$=".quantity"]').value) || 0;
        const price = parseFloat(row.querySelector('[name$=".price"]').value) || 0;
        const amount = qty * price;
        row.querySelector('[name$=".amount"]').value = amount.toFixed(2);

        recalculateTotal();
    }

    function recalculateTotal() {
        let total = 0;
        document.querySelectorAll('[name$=".amount"]').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('totalSum').innerText = total.toFixed(2);
    }

    function removeRow(button) {
        const row = button.closest('tr');
        row.remove();
        rowIndex--;
        recalculateTotal();
    }
</script>
<script>
    const products = /*[[${goodsList}]]*/ [];
</script>
</body>
</html>


<!--model.addAttribute("goodsList", goodsService.findAll()); // AccGoodsReference –∑ measurement-->
